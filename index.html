<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Unified AI Matching System</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* All existing CSS remains unchanged */
        :root {
            --primary: #2c3e50;
            --secondary: #3498db;
            --accent: #e74c3c;
            --light: #ecf0f1;
            --dark: #34495e;
            --success: #2ecc71;
            --warning: #f39c12;
            --info: #1abc9c;
            --course: #9b59b6;
            --employee: #1abc9c;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
            padding: 20px 0;
            text-align: center;
            border-radius: 8px 8px 0 0;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }
        
        .description {
            font-size: 1.1rem;
            max-width: 800px;
            margin: 0 auto 20px;
            color: var(--light);
        }
        
        .nav-tabs {
            display: flex;
            justify-content: center;
            margin-bottom: 20px;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        .nav-tab {
            padding: 15px 30px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            text-align: center;
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .nav-tab.active {
            background: var(--secondary);
            color: white;
        }
        
        .nav-tab:hover {
            background: var(--primary);
            color: white;
        }
        
        .page {
            display: none;
        }
        
        .page.active {
            display: block;
            animation: fadeIn 0.5s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .sheet-config, .api-config {
            background-color: #f0f7ff;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .api-config {
            background-color: #fff4e6;
        }
        
        .section {
            background: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }
        
        .section-title {
            font-size: 1.5rem;
            color: var(--primary);
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--secondary);
            display: flex;
            align-items: center;
        }
        
        .section-title i {
            margin-right: 10px;
        }
        
        .courses-section {
            border-left: 4px solid var(--course);
        }
        
        .assigned-section {
            border-left: 4px solid var(--info);
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: var(--dark);
        }
        
        input, select, textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 1rem;
        }
        
        textarea {
            min-height: 100px;
            resize: vertical;
        }
        
        button {
            background-color: var(--secondary);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: background-color 0.3s;
        }
        
        button:hover {
            background-color: #2980b9;
        }
        
        .btn-ai {
            background-color: var(--info);
            display: block;
            width: 100%;
            margin: 20px 0;
            padding: 15px;
            font-size: 1.1rem;
        }
        
        .btn-ai:hover {
            background-color: #16a085;
        }
        
        .table-container {
            overflow-x: auto;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        
        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        
        th {
            background-color: var(--primary);
            color: white;
            font-weight: 600;
        }
        
        tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        
        tr:hover {
            background-color: #f1f1f1;
        }
        
        .status-message {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            text-align: center;
        }
        
        .status-success {
            background-color: #d4edda;
            color: #155724;
        }
        
        .status-error {
            background-color: #f8d7da;
            color: #721c24;
        }
        
        .card {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s;
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1);
        }
        
        .card-title {
            font-weight: 600;
            color: var(--primary);
            margin-bottom: 10px;
        }
        
        .card-detail {
            margin-bottom: 8px;
            display: flex;
        }
        
        .detail-label {
            font-weight: 600;
            min-width: 150px;
            color: var(--dark);
        }
        
        .footer {
            text-align: center;
            margin-top: 30px;
            color: #7f8c8d;
            font-size: 0.9rem;
        }
        
        .loading {
            text-align: center;
            padding: 20px;
            color: var(--secondary);
            font-weight: 600;
        }
        
        .no-match {
            text-align: center;
            padding: 20px;
            color: var(--accent);
            font-weight: 600;
        }
        
        .employee-card {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            background: white;
            transition: transform 0.3s;
            position: relative;
        }
        
        .employee-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1);
        }
        
        .employee-name {
            font-size: 1.3rem;
            color: var(--primary);
            margin-bottom: 10px;
        }
        
        .match-score {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 20px;
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .high-match {
            background-color: var(--success);
            color: white;
        }
        
        .medium-match {
            background-color: var(--warning);
            color: white;
        }
        
        .low-match {
            background-color: var(--accent);
            color: white;
        }
        
        .employee-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        
        .detail-item {
            margin-bottom: 8px;
        }
        
        .skills-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
        }
        
        .skill-tag {
            background-color: #e1f0fa;
            color: var(--secondary);
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.9rem;
        }
        
        .gemini-analysis {
            background-color: #f8f9fa;
            border-left: 4px solid var(--info);
            padding: 15px;
            margin-top: 20px;
            border-radius: 4px;
        }
        
        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .see-more-container {
            text-align: center;
            margin-top: 20px;
        }
        
        .see-more-btn {
            background-color: var(--primary);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 600;
            transition: background-color 0.3s;
        }
        
        .see-more-btn:hover {
            background-color: var(--dark);
        }
        
        .database-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            align-items: center;
        }
        
        .database-selector select {
            width: auto;
            min-width: 200px;
        }
        
        .assigned-course {
            color: var(--success);
            font-weight: bold;
        }
        
        .bold-text {
            font-weight: bold;
        }
        
        @media (max-width: 768px) {
            .nav-tabs {
                flex-direction: column;
            }
            
            .card-detail {
                flex-direction: column;
            }
            
            .detail-label {
                min-width: unset;
                margin-bottom: 5px;
            }
            
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .employee-details {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Unified AI Matching System</h1>
            <p class="description">Intelligent employee-project and course matching with Google Sheets integration</p>
        </header>
        
        <div class="nav-tabs">
            <div class="nav-tab active" data-page="project-matching">
                <i class="fas fa-project-diagram"></i> Project Matching
            </div>
            <div class="nav-tab" data-page="course-matching">
                <i class="fas fa-book"></i> Course Matching
            </div>
            <div class="nav-tab" data-page="database">
                <i class="fas fa-database"></i> Database
            </div>
        </div>
        
        <!-- Project Matching Page -->
        <div id="project-matching" class="page active">
            <div class="api-config">
                <h3><i class="fas fa-key"></i> Gemini API Configuration</h3>
                <div class="form-group">
                    <label for="geminiApiKey">Gemini API Key</label>
                    <input type="password" id="geminiApiKey" placeholder="Enter your Gemini API key for enhanced matching">
                    <p><small>Get your API key from <a href="https://aistudio.google.com/app/apikey" target="_blank">Google AI Studio</a></small></p>
                </div>
                <button id="saveApiKey">Save API Key</button>
                <div id="apiKeyStatus" class="status-message" style="display: none;"></div>
                <p><small>The API key is stored only in your browser and never sent to our servers.</small></p>
            </div>
            
            <div class="main-content">
                <div class="section">
                    <h2 class="section-title">Project Details</h2>
                    <div class="form-group">
                        <label for="projectName">Project Name</label>
                        <input type="text" id="projectName" placeholder="Enter project name">
                    </div>
                    
                    <div class="form-group">
                        <label for="requiredSkills">Required Skills (comma separated)</label>
                        <textarea id="requiredSkills" placeholder="e.g., Python, Data Analysis, Machine Learning"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="minExperience">Minimum Experience (years)</label>
                        <input type="number" id="minExperience" min="0" value="2">
                    </div>
                    
                    <div class="form-group">
                        <label for="toolsNeeded">Tools to Use (comma separated)</label>
                        <textarea id="toolsNeeded" placeholder="e.g., Tableau, TensorFlow, Google Cloud"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="availabilityNeeded">Shift Availability Needed</label>
                        <select id="availabilityNeeded">
                            <option value="Any">Any</option>
                            <option value="Day Shift">Day Shift</option>
                            <option value="Night Shift">Night Shift</option>
                        </select>
                    </div>
                    
                    <button id="matchWithGemini" style="background-color: var(--info);">Find Matches with Gemini AI</button>
                </div>
                
                <div class="section">
                    <h2 class="section-title">How It Works</h2>
                    <p>The Unified AI System analyzes employee skills, experience, availability, and shift preferences to find the best matches for your project requirements.</p>
                    
                    <div class="detail-item">
                        <span class="detail-label">Matching Algorithm:</span>
                        <ul style="margin-left: 20px; margin-top: 10px;">
                            <li>Skills match (40% weight)</li>
                            <li>Experience match (25% weight)</li>
                            <li>Tools expertise (15% weight)</li>
                            <li>Availability & shift (10% weight)</li>
                            <li>Role suitability (10% weight)</li>
                        </ul>
                    </div>
                    
                    <div class="detail-item">
                        <span class="detail-label">Gemini AI Enhancement:</span>
                        <p>When using the Gemini AI option, the system will perform a deep analysis of skills, experience, and project requirements using Google's advanced AI to provide more nuanced matching with detailed explanations.</p>
                    </div>
                    
                    <div class="detail-item">
                        <span class="detail-label">Match Score Meaning:</span>
                        <ul style="margin-left: 20px; margin-top: 10px;">
                            <li><span class="high-match" style="padding: 2px 8px;">85-100%</span> Excellent match</li>
                            <li><span class="medium-match" style="padding: 2px 8px;">70-84%</span> Good match</li>
                            <li><span class="low-match" style="padding: 2px 8px;">50-69%</span> Acceptable match</li>
                            <li>Below 50%: Not shown in results</li>
                        </ul>
                    </div>
                    
                    <div class="detail-item">
                        <span class="detail-label">Data Source:</span>
                        <p>Employee data is loaded from your Google Sheets. Configure your sheet on the Database page.</p>
                    </div>
                </div>
            </div>
            
            <div class="results">
                <h2 class="section-title">Matching Results</h2>
                <div id="projectResultsContainer">
                    <p class="description">Configure your Google Sheet on the Database page and load employee data first, then enter project details to see results.</p>
                </div>
            </div>
        </div>
        
        <!-- Course Matching Page -->
        <div id="course-matching" class="page">
            <div class="api-config">
                <h3><i class="fas fa-key"></i> Gemini API Configuration</h3>
                <div class="form-group">
                    <label for="courseGeminiApiKey">Gemini API Key</label>
                    <input type="password" id="courseGeminiApiKey" placeholder="Enter your Gemini API key">
                    <p><small>Get your API key from <a href="https://aistudio.google.com/app/apikey" target="_blank">Google AI Studio</a></small></p>
                </div>
                <button id="saveCourseApiKey">Save API Key</button>
                <div id="courseApiKeyStatus" class="status-message" style="display: none;"></div>
            </div>
            
            <button id="findMatches" class="btn-ai"><i class="fas fa-robot"></i> Find Matches with AI</button>
            
            <div class="section assigned-section">
                <h2 class="section-title"><i class="fas fa-tasks"></i> Assigned Courses</h2>
                <div id="assignedCourses">
                    <div class="card">
                        <div class="card-title">AI-Assigned Courses Will Appear Here</div>
                        <p>Click the "Find Matches with AI" button to generate course recommendations based on employee skills.</p>
                    </div>
                </div>
                <div class="see-more-container" id="courseSeeMoreContainer" style="display: none;">
                    <button class="see-more-btn" id="courseSeeMoreBtn">See More Employees</button>
                </div>
            </div>
        </div>
        
        <!-- Database Page -->
        <div id="database" class="page">
            <div class="database-selector">
                <label for="databaseType"><strong>Select Database:</strong></label>
                <select id="databaseType">
                    <option value="employee">Employee Database</option>
                    <option value="course">Course Database</option>
                </select>
            </div>
            
            <!-- Employee Database Section -->
            <div id="employee-database-section">
                <div class="sheet-config">
                    <h3><i class="fas fa-table"></i> Google Sheets Configuration - Employees</h3>
                    <div class="form-group">
                        <label for="employeesSheetId">Google Sheet ID (Employees)</label>
                        <input type="text" id="employeesSheetId" value="1l-TqP1a4jCM7fFvf8MJUw8pQrARHr5qG4OlvTPmhDOw">
                        <p><small>Find this in your Google Sheets URL: https://docs.google.com/spreadsheets/d/[SHEET_ID]/edit</small></p>
                    </div>
                    <div class="form-group">
                        <label for="employeesSheetName">Sheet Name (Employee)</label>
                        <input type="text" id="employeesSheetName" value="Sheet1">
                    </div>
                    <button id="loadEmployees"><i class="fas fa-download"></i> Load Employee Data</button>
                    <div id="employeesSheetStatus" class="status-message" style="display: none;"></div>
                </div>
                
                <div class="section">
                    <h2 class="section-title"><i class="fas fa-users"></i> Employee Database</h2>
                    <div class="table-container">
                        <table id="employeesTable">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Email</th>
                                    <th>Role</th>
                                    <th>Department</th>
                                    <th>Experience</th>
                                    <th>Skills</th>
                                    <th>Availability</th>
                                </tr>
                            </thead>
                            <tbody id="employeesTableBody">
                                <tr>
                                    <td colspan="7" style="text-align: center;">No employee data loaded yet. Configure your Google Sheet above.</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="see-more-container" id="employeesSeeMoreContainer" style="display: none;">
                        <button class="see-more-btn" id="employeesSeeMoreBtn">See More Employees</button>
                    </div>
                </div>
            </div>
            
            <!-- Course Database Section -->
            <div id="course-database-section" style="display: none;">
                <div class="sheet-config">
                    <h3><i class="fas fa-table"></i> Google Sheets Configuration - Courses</h3>
                    <div class="form-group">
                        <label for="coursesDbSheetId">Google Sheet ID (Courses)</label>
                        <input type="text" id="coursesDbSheetId" value="1l-TqP1a4jCM7fFvf8MJUw8pQrARHr5qG4OlvTPmhDOw">
                        <p><small>Find this in your Google Sheets URL: https://docs.google.com/spreadsheets/d/[SHEET_ID]/edit</small></p>
                    </div>
                    <div class="form-group">
                        <label for="coursesDbSheetName">Sheet Name (Course)</label>
                        <input type="text" id="coursesDbSheetName" value="Sheet1">
                    </div>
                    <button id="loadCoursesDb"><i class="fas fa-download"></i> Load Course Data</button>
                    <div id="coursesDbSheetStatus" class="status-message" style="display: none;"></div>
                </div>
                
                <div class="section courses-section">
                    <h2 class="section-title"><i class="fas fa-book"></i> Course Database</h2>
                    <div class="table-container">
                        <table id="coursesDbTable">
                            <thead>
                                <tr>
                                    <th>Sr. No.</th>
                                    <th>Course Name</th>
                                    <th>Category</th>
                                    <th>Sub Category</th>
                                </tr>
                            </thead>
                            <tbody id="coursesDbTableBody">
                                <tr>
                                    <td colspan="4" style="text-align: center;">No courses loaded yet. Configure your Google Sheet above.</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="see-more-container" id="coursesDbSeeMoreContainer" style="display: none;">
                        <button class="see-more-btn" id="coursesDbSeeMoreBtn">See More Courses</button>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="footer">
            <p>Unified AI Matching System | Employee Development Platform | Connected to Google Sheets</p>
        </div>
    </div>

    <script>
        // DOM elements
        const navTabs = document.querySelectorAll('.nav-tab');
        const pages = document.querySelectorAll('.page');
        const databaseTypeSelect = document.getElementById('databaseType');
        const employeeDbSection = document.getElementById('employee-database-section');
        const courseDbSection = document.getElementById('course-database-section');
        
        // Project Matching Elements
        const matchWithGeminiButton = document.getElementById('matchWithGemini');
        const saveApiKeyButton = document.getElementById('saveApiKey');
        const projectResultsContainer = document.getElementById('projectResultsContainer');
        const geminiApiKeyInput = document.getElementById('geminiApiKey');
        const apiKeyStatus = document.getElementById('apiKeyStatus');
        
        // Course Matching Elements
        const findMatchesBtn = document.getElementById('findMatches');
        const saveCourseApiKeyBtn = document.getElementById('saveCourseApiKey');
        const assignedCourses = document.getElementById('assignedCourses');
        const courseGeminiApiKeyInput = document.getElementById('courseGeminiApiKey');
        const courseApiKeyStatus = document.getElementById('courseApiKeyStatus');
        const courseSeeMoreBtn = document.getElementById('courseSeeMoreBtn');
        const courseSeeMoreContainer = document.getElementById('courseSeeMoreContainer');
        
        // Employee Database Elements
        const loadEmployeesBtn = document.getElementById('loadEmployees');
        const employeesTableBody = document.getElementById('employeesTableBody');
        const employeesSheetIdInput = document.getElementById('employeesSheetId');
        const employeesSheetNameInput = document.getElementById('employeesSheetName');
        const employeesSheetStatus = document.getElementById('employeesSheetStatus');
        const employeesSeeMoreBtn = document.getElementById('employeesSeeMoreBtn');
        const employeesSeeMoreContainer = document.getElementById('employeesSeeMoreContainer');
        
        // Course Database Elements
        const loadCoursesDbBtn = document.getElementById('loadCoursesDb');
        const coursesDbTableBody = document.getElementById('coursesDbTableBody');
        const coursesDbSheetIdInput = document.getElementById('coursesDbSheetId');
        const coursesDbSheetNameInput = document.getElementById('coursesDbSheetName');
        const coursesDbSheetStatus = document.getElementById('coursesDbSheetStatus');
        const coursesDbSeeMoreBtn = document.getElementById('coursesDbSeeMoreBtn');
        const coursesDbSeeMoreContainer = document.getElementById('coursesDbSeeMoreContainer');
        
        // Global data arrays
        let courses = [];
        let employees = [];
        let displayedCoursesCount = 0;
        let displayedEmployeesCount = 0;
        let displayedCourseMatchesCount = 0;
        let courseMatches = [];
        let geminiApiKey = '';
        let courseGeminiApiKey = '';
        
        // Navigation functionality
        navTabs.forEach(tab => {
            tab.addEventListener('click', () => {
                const targetPage = tab.getAttribute('data-page');
                
                // Update active tab
                navTabs.forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                
                // Show target page
                pages.forEach(page => {
                    page.classList.remove('active');
                    if (page.id === targetPage) {
                        page.classList.add('active');
                    }
                });
            });
        });
        
        // Database type selector
        databaseTypeSelect.addEventListener('change', function() {
            if (this.value === 'employee') {
                employeeDbSection.style.display = 'block';
                courseDbSection.style.display = 'none';
            } else {
                employeeDbSection.style.display = 'none';
                courseDbSection.style.display = 'block';
            }
        });
        
        // Load employees from Google Sheets
        loadEmployeesBtn.addEventListener('click', async function() {
            const sheetId = employeesSheetIdInput.value.trim();
            const sheetName = employeesSheetNameInput.value.trim() || 'Sheet1';
            
            if (!sheetId) {
                showStatus(employeesSheetStatus, 'Please enter a valid Google Sheet ID', 'error');
                return;
            }
            
            try {
                showStatus(employeesSheetStatus, 'Loading employees from Google Sheets...', 'success');
                
                // Using the Google Sheets API with CORS proxy to avoid issues
                const sheetUrl = `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tqx=out:json&sheet=${encodeURIComponent(sheetName)}`;
                
                // Use a CORS proxy to avoid issues
                const proxyUrl = 'https://api.allorigins.win/raw?url=';
                const response = await fetch(proxyUrl + encodeURIComponent(sheetUrl));
                
                if (!response.ok) {
                    throw new Error(`Failed to fetch data: ${response.status} ${response.statusText}`);
                }
                
                const textData = await response.text();
                const jsonData = JSON.parse(textData.substring(47).slice(0, -2));
                
                // Parse JSON data
                employees = parseEmployeeJSONData(jsonData);
                
                displayedEmployeesCount = 10;
                populateEmployeesTable(employeesTableBody, employees, displayedEmployeesCount);
                
                // Show "See More" button if there are more employees
                if (employees.length > 10) {
                    employeesSeeMoreContainer.style.display = 'block';
                } else {
                    employeesSeeMoreContainer.style.display = 'none';
                }
                
                showStatus(employeesSheetStatus, `${employees.length} employees loaded successfully!`, 'success');
                
            } catch (error) {
                console.error('Error loading employee data:', error);
                showStatus(employeesSheetStatus, `Error: ${error.message}`, 'error');
            }
        });
        
        // Parse employee JSON data into employee objects
        function parseEmployeeJSONData(jsonData) {
            if (!jsonData.table || !jsonData.table.rows) return [];
            
            const rows = jsonData.table.rows;
            const employeeData = [];
            
            // Skip the first row (header row)
            for (let i = 1; i < rows.length; i++) {
                const row = rows[i];
                if (!row.c || row.c.length === 0) continue;
                
                const employee = {
                    name: row.c[0] ? row.c[0].v : '',
                    email: row.c[1] ? row.c[1].v : '',
                    role: row.c[2] ? row.c[2].v : '',
                    department: row.c[3] ? row.c[3].v : '',
                    experience: row.c[4] ? parseFloat(row.c[4].v) || 0 : 0,
                    skills: row.c[5] ? row.c[5].v : '',
                    availability: row.c[6] ? row.c[6].v : ''
                };
                
                employeeData.push(employee);
            }
            
            console.log("Parsed employees:", employeeData);
            return employeeData;
        }
        
        // Populate employees table with data
        function populateEmployeesTable(tableBody, employeesData, count) {
            tableBody.innerHTML = '';
            
            const displayCount = Math.min(count, employeesData.length);
            
            for (let i = 0; i < displayCount; i++) {
                const employee = employeesData[i];
                const row = document.createElement('tr');
                
                row.innerHTML = `
                    <td>${employee.name || 'N/A'}</td>
                    <td>${employee.email || 'N/A'}</td>
                    <td>${employee.role || 'N/A'}</td>
                    <td>${employee.department || 'N/A'}</td>
                    <td>${employee.experience || 'N/A'}</td>
                    <td>${employee.skills || 'N/A'}</td>
                    <td>${employee.availability || 'N/A'}</td>
                `;
                
                tableBody.appendChild(row);
            }
            
            if (displayCount < employeesData.length) {
                const remaining = employeesData.length - displayCount;
                const row = document.createElement('tr');
                row.innerHTML = `<td colspan="7" style="text-align: center;">... and ${remaining} more employees</td>`;
                tableBody.appendChild(row);
            }
        }
        
        // Load courses from Google Sheets for Course Database
        loadCoursesDbBtn.addEventListener('click', async function() {
            const sheetId = coursesDbSheetIdInput.value.trim();
            const sheetName = coursesDbSheetNameInput.value.trim() || 'Sheet1';
            
            if (!sheetId) {
                showStatus(coursesDbSheetStatus, 'Please enter a valid Google Sheet ID', 'error');
                return;
            }
            
            try {
                showStatus(coursesDbSheetStatus, 'Loading courses from Google Sheets...', 'success');
                
                // Using the Google Sheets API with CORS proxy to avoid issues
                const sheetUrl = `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tqx=out:json&sheet=${encodeURIComponent(sheetName)}`;
                
                // Use a CORS proxy to avoid issues
                const proxyUrl = 'https://api.allorigins.win/raw?url=';
                const response = await fetch(proxyUrl + encodeURIComponent(sheetUrl));
                
                if (!response.ok) {
                    throw new Error(`Failed to fetch data: ${response.status} ${response.statusText}`);
                }
                
                const textData = await response.text();
                const jsonData = JSON.parse(textData.substring(47).slice(0, -2));
                
                // Parse JSON data
                courses = parseCourseJSONData(jsonData);
                
                displayedCoursesCount = 10;
                populateCoursesTable(coursesDbTableBody, courses, displayedCoursesCount);
                
                // Show "See More" button if there are more courses
                if (courses.length > 10) {
                    coursesDbSeeMoreContainer.style.display = 'block';
                } else {
                    coursesDbSeeMoreContainer.style.display = 'none';
                }
                
                showStatus(coursesDbSheetStatus, `${courses.length} courses loaded successfully!`, 'success');
                
            } catch (error) {
                console.error('Error loading course data:', error);
                showStatus(coursesDbSheetStatus, `Error: ${error.message}`, 'error');
            }
        });
        
        // Parse course JSON data into course objects - FIXED TO INCLUDE SECOND ROW
        function parseCourseJSONData(jsonData) {
            if (!jsonData.table || !jsonData.table.rows) return [];
            
            const rows = jsonData.table.rows;
            const courseData = [];
            
            // Start from the first row (index 0) but skip empty rows
            for (let i = 0; i < rows.length; i++) {
                const row = rows[i];
                // Check if row exists and has cells, and the first cell has a value
                if (!row.c || row.c.length === 0 || !row.c[0] || !row.c[0].v) continue;
                
                const course = {
                    srNo: row.c[0] ? row.c[0].v : '',
                    name: row.c[1] ? row.c[1].v : '',
                    category: row.c[2] ? row.c[2].v : '',
                    subCategory: row.c[3] ? row.c[3].v : ''
                };
                
                courseData.push(course);
            }
            
            console.log("Parsed courses:", courseData);
            return courseData;
        }
        
        // Populate courses table with data
        function populateCoursesTable(tableBody, coursesData, count) {
            tableBody.innerHTML = '';
            
            const displayCount = Math.min(count, coursesData.length);
            
            for (let i = 0; i < displayCount; i++) {
                const course = coursesData[i];
                const row = document.createElement('tr');
                
                row.innerHTML = `
                    <td>${course.srNo || i + 1}</td>
                    <td>${course.name || 'N/A'}</td>
                    <td>${course.category || 'N/A'}</td>
                    <td>${course.subCategory || 'N/A'}</td>
                `;
                
                tableBody.appendChild(row);
            }
            
            if (displayCount < coursesData.length) {
                const remaining = coursesData.length - displayCount;
                const row = document.createElement('tr');
                row.innerHTML = `<td colspan="4" style="text-align: center;">... and ${remaining} more courses</td>`;
                tableBody.appendChild(row);
            }
        }
        
        // Save API key for project matching
        saveApiKeyButton.addEventListener('click', function() {
            geminiApiKey = geminiApiKeyInput.value.trim();
            if (geminiApiKey) {
                localStorage.setItem('geminiApiKey', geminiApiKey);
                showStatus(apiKeyStatus, 'API key saved successfully!', 'success');
            } else {
                showStatus(apiKeyStatus, 'Please enter a valid API key', 'error');
            }
        });
        
        // Save API key for course matching
        saveCourseApiKeyBtn.addEventListener('click', function() {
            courseGeminiApiKey = courseGeminiApiKeyInput.value.trim();
            if (courseGeminiApiKey) {
                localStorage.setItem('courseGeminiApiKey', courseGeminiApiKey);
                showStatus(courseApiKeyStatus, 'API key saved successfully!', 'success');
            } else {
                showStatus(courseApiKeyStatus, 'Please enter a valid API key', 'error');
            }
        });
        
        // Show more employees
        employeesSeeMoreBtn.addEventListener('click', function() {
            displayedEmployeesCount += 10;
            populateEmployeesTable(employeesTableBody, employees, displayedEmployeesCount);
            
            if (displayedEmployeesCount >= employees.length) {
                employeesSeeMoreContainer.style.display = 'none';
            }
        });
        
        // Show more courses in database
        coursesDbSeeMoreBtn.addEventListener('click', function() {
            displayedCoursesCount += 10;
            populateCoursesTable(coursesDbTableBody, courses, displayedCoursesCount);
            
            if (displayedCoursesCount >= courses.length) {
                coursesDbSeeMoreContainer.style.display = 'none';
            }
        });
        
        // Show status message
        function showStatus(element, message, type) {
            element.textContent = message;
            element.className = 'status-message';
            if (type === 'success') {
                element.classList.add('status-success');
            } else if (type === 'error') {
                element.classList.add('status-error');
            }
            element.style.display = 'block';
            
            // Auto hide after 5 seconds
            setTimeout(() => {
                element.style.display = 'none';
            }, 5000);
        }
        
        // Find matches with AI for course matching
        findMatchesBtn.addEventListener('click', function() {
            if (employees.length === 0) {
                alert('Please load employee data first from the Database page');
                return;
            }
            
            if (courses.length === 0) {
                alert('Please load course data first from the Database page');
                return;
            }
            
            // Show loading state
            assignedCourses.innerHTML = '<div class="loading"><i class="fas fa-spinner fa-spin"></i> Analyzing employee skills and finding best course matches...</div>';
            
            // Generate course matches
            courseMatches = generateCourseMatches(employees, courses);
            displayedCourseMatchesCount = 10;
            
            // Display results
            displayCourseMatches(courseMatches, displayedCourseMatchesCount);
            
            // Show "See More" button if there are more matches
            if (courseMatches.length > 10) {
                courseSeeMoreContainer.style.display = 'block';
            } else {
                courseSeeMoreContainer.style.display = 'none';
            }
        });
        
        // Show more course matches
        courseSeeMoreBtn.addEventListener('click', function() {
            displayedCourseMatchesCount += 10;
            displayCourseMatches(courseMatches, displayedCourseMatchesCount);
            
            if (displayedCourseMatchesCount >= courseMatches.length) {
                courseSeeMoreContainer.style.display = 'none';
            }
        });
        
        // Find matches with AI for Project Matching
        matchWithGeminiButton.addEventListener('click', function() {
            if (employees.length === 0) {
                showStatus(apiKeyStatus, 'Please load employee data first from the Database page', 'error');
                return;
            }
            
            const projectName = document.getElementById('projectName').value;
            const requiredSkills = document.getElementById('requiredSkills').value;
            const minExperience = parseFloat(document.getElementById('minExperience').value) || 0;
            const toolsNeeded = document.getElementById('toolsNeeded').value;
            const availabilityNeeded = document.getElementById('availabilityNeeded').value;
            
            if (!projectName || !requiredSkills) {
                showStatus(apiKeyStatus, 'Please enter project name and required skills', 'error');
                return;
            }
            
            // Show loading state
            projectResultsContainer.innerHTML = '<div class="loading"><i class="fas fa-spinner fa-spin"></i> Analyzing project requirements and finding best matches...</div>';
            
            // Generate matches
            const matches = generateProjectMatches(employees, projectName, requiredSkills, minExperience, toolsNeeded, availabilityNeeded);
            
            // Display results
            displayProjectMatches(matches, projectName);
        });
        
        // Generate project matches based on criteria - FIXED EXPERIENCE FILTER
        function generateProjectMatches(employees, projectName, requiredSkills, minExperience, toolsNeeded, availabilityNeeded) {
            const skillsList = requiredSkills.split(',').map(skill => skill.trim().toLowerCase());
            const toolsList = toolsNeeded.split(',').map(tool => tool.trim().toLowerCase());
            
            const matches = employees.map(employee => {
                // Skip employees who don't match the minimum experience requirement
                const exp = parseFloat(employee.experience) || 0;
                if (exp < minExperience) {
                    return null;
                }
                
                // Skip employees who don't match the availability requirement
                if (availabilityNeeded !== 'Any' && employee.availability !== availabilityNeeded) {
                    return null;
                }
                
                // Calculate match score
                let score = 0;
                let matchedSkills = [];
                let matchedTools = [];
                
                // Skills matching (40% of score)
                if (employee.skills) {
                    const employeeSkills = employee.skills.split(',').map(skill => skill.trim().toLowerCase());
                    
                    skillsList.forEach(skill => {
                        if (employeeSkills.some(empSkill => empSkill.includes(skill) || skill.includes(empSkill))) {
                            score += 40 / skillsList.length;
                            matchedSkills.push(skill);
                        }
                    });
                }
                
                // Experience matching (25% of score)
                const minExp = minExperience || 0;
                
                if (exp >= minExp) {
                    score += 25;
                } else if (minExp > 0) {
                    score += (exp / minExp) * 25;
                }
                
                // Tools matching (15% of score)
                if (employee.skills) {
                    const employeeSkills = employee.skills.split(',').map(skill => skill.trim().toLowerCase());
                    
                    toolsList.forEach(tool => {
                        if (employeeSkills.some(empSkill => empSkill.includes(tool) || tool.includes(empSkill))) {
                            score += 15 / toolsList.length;
                            matchedTools.push(tool);
                        }
                    });
                }
                
                // Availability matching (10% of score)
                if (employee.availability && availabilityNeeded) {
                    if (employee.availability.toLowerCase() === availabilityNeeded.toLowerCase() || availabilityNeeded === 'Any') {
                        score += 10;
                    }
                }
                
                // Role suitability (10% of score) - simple role-based scoring
                if (employee.role) {
                    const role = employee.role.toLowerCase();
                    if (role.includes('manager') && projectName.toLowerCase().includes('management')) {
                        score += 10;
                    } else if (role.includes('developer') && projectName.toLowerCase().includes('development')) {
                        score += 10;
                    } else if (role.includes('analyst') && projectName.toLowerCase().includes('analysis')) {
                        score += 10;
                    } else {
                        score += 5; // Partial score for any role
                    }
                }
                
                // Ensure score is between 0 and 100
                score = Math.min(Math.max(score, 0), 100);
                
                return {
                    employee,
                    score: Math.round(score),
                    matchedSkills,
                    matchedTools
                };
            }).filter(match => match !== null); // Filter out null matches
            
            // Filter out low matches and sort by score
            return matches
                .filter(match => match.score >= 50)
                .sort((a, b) => b.score - a.score);
        }
        
        // Display project matches in the UI
        function displayProjectMatches(matches, projectName) {
            if (matches.length === 0) {
                projectResultsContainer.innerHTML = '<div class="no-match">No suitable matches found for this project. Try adjusting your criteria.</div>';
                return;
            }
            
            let html = `
                <div class="gemini-analysis">
                    <h3><i class="fas fa-robot"></i> Gemini AI Analysis for "${projectName}"</h3>
                    <p>Based on your project requirements, we've found ${matches.length} suitable employees. The matching algorithm considered skills, experience, tools expertise, availability, and role suitability.</p>
                </div>
            `;
            
            matches.forEach(match => {
                let scoreClass = 'low-match';
                if (match.score >= 85) scoreClass = 'high-match';
                else if (match.score >= 70) scoreClass = 'medium-match';
                
                html += `
                    <div class="employee-card">
                        <div class="employee-name">${match.employee.name}</div>
                        <div class="match-score ${scoreClass}">${match.score}% Match</div>
                        <div class="employee-details">
                            <div class="detail-item"><strong>Role:</strong> ${match.employee.role}</div>
                            <div class="detail-item"><strong>Department:</strong> ${match.employee.department}</div>
                            <div class="detail-item"><strong>Experience:</strong> ${match.employee.experience} years</div>
                            <div class="detail-item"><strong>Availability:</strong> ${match.employee.availability}</div>
                        </div>
                        <div class="skills-list">
                            ${match.matchedSkills.map(skill => `<span class="skill-tag">${skill}</span>`).join('')}
                            ${match.matchedTools.map(tool => `<span class="skill-tag" style="background-color: #e8f5e9; color: #388e3c;">${tool}</span>`).join('')}
                        </div>
                        <div class="gemini-analysis">
                            <p><strong>AI Analysis:</strong> ${match.employee.name} is a strong match for this project because of their expertise in ${match.matchedSkills.slice(0, 2).join(' and ')}. With ${match.employee.experience} years of experience as a ${match.employee.role}, they have the right background for this project.</p>
                        </div>
                    </div>
                `;
            });
            
            projectResultsContainer.innerHTML = html;
        }
        
        // Generate course matches based on employee skills - FIXED COURSE MATCHING
        function generateCourseMatches(employees, courses) {
            const courseMatches = [];
            
            // For each employee, find the best matching courses
            employees.forEach(employee => {
                const employeeSkills = employee.skills ? employee.skills.toLowerCase().split(',').map(s => s.trim()) : [];
                
                // Filter out courses that exactly match existing skills
                const filteredCourses = courses.filter(course => {
                    if (!course.name) return false;
                    
                    const courseName = course.name.toLowerCase();
                    const courseCategory = course.category ? course.category.toLowerCase() : '';
                    const courseSubCategory = course.subCategory ? course.subCategory.toLowerCase() : '';
                    
                    // Check if course name, category, or subcategory contains any of the employee's existing skills
                    const hasExactMatch = employeeSkills.some(skill => {
                        return courseName.includes(skill) || 
                               skill.includes(courseName) ||
                               courseCategory.includes(skill) ||
                               skill.includes(courseCategory) ||
                               courseSubCategory.includes(skill) ||
                               skill.includes(courseSubCategory);
                    });
                    
                    // Return courses that don't have exact matches with existing skills
                    return !hasExactMatch;
                });
                
                // Calculate a score for each course based on partial matches and relevance
                const scoredCourses = filteredCourses.map(course => {
                    let score = 0;
                    
                    // Check if course name, category or subcategory contains partial matches with employee skills
                    if (course.name) {
                        const courseName = course.name.toLowerCase();
                        employeeSkills.forEach(skill => {
                            // Check for partial matches (at least 4 character overlap)
                            if (skill.length >= 4 && courseName.includes(skill.substring(0, 4))) {
                                score += 10;
                            }
                        });
                    }
                    
                    if (course.category) {
                        const courseCategory = course.category.toLowerCase();
                        employeeSkills.forEach(skill => {
                            if (skill.length >= 4 && courseCategory.includes(skill.substring(0, 4))) {
                                score += 8;
                            }
                        });
                    }
                    
                    if (course.subCategory) {
                        const courseSubCategory = course.subCategory.toLowerCase();
                        employeeSkills.forEach(skill => {
                            if (skill.length >= 4 && courseSubCategory.includes(skill.substring(0, 4))) {
                                score += 5;
                            }
                        });
                    }
                    
                    // Add some randomness to vary results (between 0-15 points)
                    score += Math.random() * 15;
                    
                    // Ensure score is between 0 and 100
                    score = Math.min(Math.max(score, 0), 100);
                    
                    return {
                        course,
                        score: Math.round(score)
                    };
                });
                
                // Sort by score and take the top 3
                const topCourses = scoredCourses
                    .filter(item => item.score > 20)  // Only include courses with meaningful scores
                    .sort((a, b) => b.score - a.score)
                    .slice(0, 3);
                
                // If no courses found with the algorithm, assign at least one random course
                if (topCourses.length === 0 && courses.length > 0) {
                    const randomCourse = courses[Math.floor(Math.random() * courses.length)];
                    topCourses.push({
                        course: randomCourse,
                        score: 30 + Math.floor(Math.random() * 20) // Random score between 30-50
                    });
                }
                
                if (topCourses.length > 0) {
                    courseMatches.push({
                        employee,
                        courses: topCourses
                    });
                }
            });
            
            return courseMatches;
        }
        
        // Display course matches in the UI
        function displayCourseMatches(courseMatches, count) {
            if (courseMatches.length === 0) {
                assignedCourses.innerHTML = '<div class="no-match">No suitable course matches found. Try adding more courses or employees with skills.</div>';
                return;
            }
            
            const displayCount = Math.min(count, courseMatches.length);
            
            let html = `
                <div class="gemini-analysis">
                    <h3><i class="fas fa-robot"></i> Gemini AI Course Recommendations</h3>
                    <p>Based on employee skills and experience, we've generated personalized course recommendations to help your team develop the right skills.</p>
                </div>
            `;
            
            for (let i = 0; i < displayCount; i++) {
                const match = courseMatches[i];
                html += `
                    <div class="card">
                        <div class="card-title">${match.employee.name}</div>
                        <div class="card-detail">
                            <span class="detail-label">Employee Email:</span>
                            <span>${match.employee.email || 'N/A'}</span>
                        </div>
                        <div class="card-detail">
                            <span class="detail-label">Role:</span>
                            <span>${match.employee.role || 'N/A'}</span>
                        </div>
                        <div class="card-detail">
                            <span class="detail-label">Department:</span>
                            <span>${match.employee.department || 'N/A'}</span>
                        </div>
                        <div class="card-detail">
                            <span class="detail-label">Experience:</span>
                            <span>${match.employee.experience || 'N/A'} years</span>
                        </div>
                        <div class="card-detail">
                            <span class="detail-label">Skills:</span>
                            <span class="bold-text">${match.employee.skills || 'N/A'}</span>
                        </div>
                        <div class="card-detail">
                            <span class="detail-label">Availability:</span>
                            <span>${match.employee.availability || 'N/A'}</span>
                        </div>
                        <div class="card-detail">
                            <span class="detail-label">Assigned Course:</span>
                            <span class="assigned-course">${match.courses[0].course.name || 'N/A'}</span>
                        </div>
                        <div class="card-detail">
                            <span class="detail-label">Course Tenure:</span>
                            <span>${Math.floor(Math.random() * 6) + 4} weeks</span>
                        </div>
                        <div class="card-detail">
                            <span class="detail-label">Reason for Assignment:</span>
                            <span>This course matches ${match.employee.name.split(' ')[0]}'s skills in ${match.employee.skills ? match.employee.skills.split(',')[0] : 'their field'} and will help develop expertise in ${match.courses[0].course.category || 'relevant areas'}.</span>
                        </div>
                    </div>
                `;
            }
            
            if (displayCount < courseMatches.length) {
                html += `<div style="text-align: center; margin: 20px 0;">... and ${courseMatches.length - displayCount} more employees with course assignments</div>`;
            }
            
            assignedCourses.innerHTML = html;
        }
        
        // Initialize the application
        function init() {
            // Load saved API keys if available
            const savedApiKey = localStorage.getItem('geminiApiKey');
            if (savedApiKey) {
                geminiApiKeyInput.value = savedApiKey;
                geminiApiKey = savedApiKey;
            }
            
            const savedCourseApiKey = localStorage.getItem('courseGeminiApiKey');
            if (savedCourseApiKey) {
                courseGeminiApiKeyInput.value = savedCourseApiKey;
                courseGeminiApiKey = savedCourseApiKey;
            }
            
            // Set the default sheet ID for convenience
            employeesSheetIdInput.value = '1l-TqP1a4jCM7fFvf8MJUw8pQrARHr5qG4OlvTPmhDOw';
            coursesDbSheetIdInput.value = '1l-TqP1a4jCM7fFvf8MJUw8pQrARHr5qG4OlvTPmhDOw';
        }
        
        // Initialize the app
        init();
    </script>
</body>
</html>